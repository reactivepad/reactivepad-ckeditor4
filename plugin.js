"use strict";function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter)}function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}}function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter((function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach((function(key){_defineProperty(target,key,source[key])}))}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source))}else{ownKeys(Object(source)).forEach((function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))}))}}return target}function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}var PLUGIN_NAME="reactivepad";var _ReactivepadCore=ReactivepadCore,createStore=_ReactivepadCore.createStore,components=_ReactivepadCore.components,observer=_ReactivepadCore.observer;var Formula=components.Formula,FormulaForm=components.FormulaForm,Table=components.Table;var FORMULA_TYPE="formula";var TABLE_TYPE="table";var store=createStore();var ATTRIBUTE_PREFIX="rp";var createAttribute=function createAttribute(attr){var prefix=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ATTRIBUTE_PREFIX;return"data-".concat(prefix,"-").concat(attr)};var ATTRIBUTE_ID=createAttribute("id");var ATTRIBUTE_TYPE=createAttribute("type");var ATTRIBUTE_DATA=createAttribute("data");var DIALOGS_NAMES={formula:"".concat(ATTRIBUTE_PREFIX,"-formula-dialog"),table:"".concat(ATTRIBUTE_PREFIX,"-table-dialog")};var WIDGETS_NAMES={formula:"rp-formula-widget",table:"rp-table-widget"};var createElement=function createElement(Component,props,editor){var query="[".concat(ATTRIBUTE_ID,'="').concat(props.node.id,'"]');var targetElement=editor.document.$.body.querySelector(query);var el=React.createElement(Component,props,null);ReactDOM.render(el,targetElement)};var isInitialLoad=function isInitialLoad(attrs){return!!attrs[ATTRIBUTE_ID]};CKEDITOR.plugins.add(PLUGIN_NAME,{requires:"widget,dialog",init:function init(editor){if(editor.blockless){return}var stylesPath=CKEDITOR.plugins.get(PLUGIN_NAME).path+"styles/reactivepad.css";editor.addContentsCss(stylesPath);CKEDITOR.document.appendStyleSheet(stylesPath);var dialogOnLoad=function dialogOnLoad(context,className){context.getElement().$.classList.remove("cke_reset_all");context.getElement().$.classList.add(className)};CKEDITOR.dialog.add(DIALOGS_NAMES.formula,(function(){return{title:"Edit formula",buttons:[],minWidth:200,minHeight:150,onLoad:function onLoad(){dialogOnLoad(this,DIALOGS_NAMES.formula)},contents:[{id:"formulaForm",elements:[{type:"html",html:'<div id="formulaForm"></div>',onShow:function onShow(evt){var _evt$sender$_=evt.sender._,element=_evt$sender$_.element,model=_evt$sender$_.model;var _element$findOne=element.findOne("#formulaForm"),$=_element$findOne.$;var el=React.createElement(FormulaForm,_objectSpread({},model.formula.serialize(),{onSave:function onSave(){var _model$formula;(_model$formula=model.formula).handleSave.apply(_model$formula,arguments)},onClose:function onClose(){model.formula.toggleEditing(false)},showCloseButton:false,store:store}),null);ReactDOM.render(el,$)},onHide:function onHide(evt){var _evt$sender$_$element=evt.sender._.element.findOne("#formulaForm"),$=_evt$sender$_$element.$;ReactDOM.unmountComponentAtNode($)}}]}],onCancel:function onCancel(evt){var formula=evt.sender._.model.formula;if(formula.isEditing){formula.toggleEditing(false)}}}}));CKEDITOR.dialog.add(DIALOGS_NAMES.table,(function(){return{title:"Edit Table",buttons:[],minWidth:600,minHeight:150,onLoad:function onLoad(){dialogOnLoad(this,DIALOGS_NAMES.table)},contents:[{id:"tableForm",elements:[{type:"html",html:'<div id="tableForm"></div>',onShow:function onShow(evt){var _evt$sender$_2=evt.sender._,element=_evt$sender$_2.element,model=_evt$sender$_2.model;var _element$findOne2=element.findOne("#tableForm"),$=_element$findOne2.$;var el=React.createElement(Table,{node:model.table},null);ReactDOM.render(el,$)},onHide:function onHide(evt){var _evt$sender$_$element2=evt.sender._.element.findOne("#tableForm"),$=_evt$sender$_$element2.$;ReactDOM.unmountComponentAtNode($)}}]}]}}));editor.widgets.add(WIDGETS_NAMES.formula,{button:"Reactivepad formula",inline:true,draggable:false,template:"<span "+ATTRIBUTE_TYPE+'="'+FORMULA_TYPE+'">&nbsp;</span>',allowedContent:"span[!"+[ATTRIBUTE_ID,ATTRIBUTE_TYPE,ATTRIBUTE_DATA].join(",!")+"]",requiredContent:"span["+[ATTRIBUTE_ID,ATTRIBUTE_TYPE,ATTRIBUTE_DATA].join(",")+"]",init:function init(){var attrs=this.element.getAttributes();var props={};if(attrs[ATTRIBUTE_ID]){props=JSON.parse(attrs[ATTRIBUTE_DATA])}this.formula=store.createAndAddFormula(props);if(!attrs[ATTRIBUTE_ID]){this.element.setAttribute(ATTRIBUTE_ID,this.formula.id)}this.once("ready",(function(){var _this=this;var dialogInstance=null;var onIsEditingChanged=function onIsEditingChanged(isEditing){if(isEditing){editor.openDialog(DIALOGS_NAMES.formula,(function(dialog){dialogInstance=dialog}),{formula:_this.formula})}else if(!!dialogInstance){dialogInstance.hide();dialogInstance=null}};createElement(Formula,{node:this.formula,showFormulaFormPopover:false,showFormulaNameTooltip:false,container:editor.document.$,onIsEditingChanged:onIsEditingChanged},editor);if(!isInitialLoad(attrs)){this.formula.toggleEditing(true)}}))},downcast:function downcast(){var attributes={};attributes[ATTRIBUTE_ID]=this.formula.id;attributes[ATTRIBUTE_TYPE]=FORMULA_TYPE;attributes[ATTRIBUTE_DATA]=JSON.stringify(this.formula.serialize());var element=new CKEDITOR.htmlParser.element("span",attributes);element.setHtml("".concat(this.formula.formatted));return element},upcast:function upcast(element){return element.attributes[ATTRIBUTE_TYPE]===FORMULA_TYPE}});editor.widgets.add(WIDGETS_NAMES.table,{button:"Reactivepad table",template:"<div "+ATTRIBUTE_TYPE+'="'+TABLE_TYPE+'"></div>',allowedContent:"div[!"+[ATTRIBUTE_ID,ATTRIBUTE_TYPE,ATTRIBUTE_DATA].join(",!")+"]",requiredContent:"div["+[ATTRIBUTE_ID,ATTRIBUTE_TYPE,ATTRIBUTE_DATA].join(",")+"]",init:function init(){var attrs=this.element.getAttributes();var props={};if(attrs[ATTRIBUTE_ID]){props=JSON.parse(attrs[ATTRIBUTE_DATA])}this.table=store.createAndAddTable(props);this.table.toggleFooter(true);if(!attrs[ATTRIBUTE_ID]){this.element.setAttribute(ATTRIBUTE_ID,this.table.id)}var timeoutId;this.once("ready",(function(){var _this2=this;var openTableDialog=function openTableDialog(){editor.openDialog(DIALOGS_NAMES.table,(function(){}),{table:_this2.table})};createElement(observer(PlainTable),{node:this.table,onClick:openTableDialog},editor);if(!isInitialLoad(attrs)){timeoutId=setTimeout((function(){openTableDialog()}),5)}}));this.once("destroy",(function(){if(timeoutId){clearTimeout(timeoutId)}}))},downcast:function downcast(){var attributes={};attributes[ATTRIBUTE_ID]=this.table.id;attributes[ATTRIBUTE_TYPE]=this.table.type;var tableSerialized=this.table.serialize();attributes[ATTRIBUTE_DATA]=JSON.stringify(tableSerialized);var element=new CKEDITOR.htmlParser.element("div",attributes);element.setHtml("#");return element},upcast:function upcast(element){return element.attributes[ATTRIBUTE_TYPE]===TABLE_TYPE}});editor.on("change",(function(){store.nodes.forEach((function(node){var domNode=editor.document.$.body.querySelector("[".concat(ATTRIBUTE_ID,"=").concat(node.id,"]"));if(!domNode){node.destroy()}}))}))}});function PlainTable(_ref){var _ref$table=_ref.node,name=_ref$table.name,columns=_ref$table.columns,rows=_ref$table.rows,showFooter=_ref$table.showFooter,onClick=_ref.onClick;var self=this;var toggleHovered=function toggleHovered(isHovered){self.setState({isHovered:isHovered})};return React.createElement("div",{className:"rpTableContainer",onMouseEnter:function onMouseEnter(){return toggleHovered(true)},onMouseLeave:function onMouseLeave(){return toggleHovered(false)}},this.state&&this.state.isHovered&&React.createElement("button",{onClick:onClick,className:"rpTableEditButton"},"Edit"),React.createElement("div",{className:"rpTableWrapper"},React.createElement("table",{className:"rpTable"},React.createElement("thead",null,React.createElement("tr",null,columns.map((function(_ref2){var id=_ref2.id,name=_ref2.name,width=_ref2.width;return React.createElement("th",{key:id,className:"rpCell rpHeaderCell",style:{width:width}},name)})))),React.createElement("tbody",null,[].concat(_toConsumableArray(rows.map((function(row,i){return React.createElement("tr",{key:i,height:row.height},row.cells.map((function(_ref3,j){return React.createElement("td",{key:j,className:"rpCell"},_ref3.formatted)})))}))),[showFooter&&React.createElement("tr",{key:"footer",className:"rpFooterRow"},columns.map((function(_ref4,j){return React.createElement("td",{key:_ref4.id,className:"rpCell"},_ref4.footerFormatted)})))])))),React.createElement("div",{className:"rpTableName"},name))}